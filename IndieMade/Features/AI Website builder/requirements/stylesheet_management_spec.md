# AI Website Builder: Stylesheet Management Specification

## Executive Summary

This document outlines the recommended approach for managing CSS files and stylesheets when AI assistants build blocks and sections in the IndieMade AI Website Builder. It addresses security concerns, governance workflows, file storage strategies, and performance considerations while maintaining design system consistency.

## 1. CSS File Storage and Access Strategy

### 1.1 Recommended Approach: Controlled Style Library
**Do NOT allow direct CSS file write access to sites directory.** Instead, implement a controlled style library approach:

- **AI-Generated Styles Directory**: `themes/custom/<theme>/ai_assistant/`
- **Compilation Process**: SCSS partials compiled into versioned CSS libraries
- **Attachment Model**: CSS loaded only for blocks that require specific styles
- **Version Control**: Git-tracked style partials with audit trails

### 1.2 File Organization Structure
```
themes/custom/<theme>/
├── ai_assistant/
│   ├── utilities/           # Utility classes generated by AI
│   │   ├── _spacing.scss
│   │   ├── _typography.scss
│   │   └── _colors.scss
│   ├── components/          # Component-specific styles
│   │   ├── _hero-blocks.scss
│   │   ├── _gallery-grids.scss
│   │   └── _testimonials.scss
│   ├── layouts/             # Layout-specific styles
│   │   ├── _grid-variants.scss
│   │   └── _responsive-containers.scss
│   └── ai-assistant.scss    # Main compilation file
├── libraries.yml            # Drupal library definitions
└── style-manifest.json     # AI-readable design tokens
```

### 1.3 Access Control and Security
- **No Direct File System Access**: AI cannot write directly to the filesystem
- **API-Mediated Requests**: All style changes go through controlled endpoints
- **Human Approval Required**: Style additions require design lead approval
- **Sanitization**: All CSS runs through security filters and linting

## 2. Style Generation Workflow

### 2.1 AI Style Request Process
1. **AI Analysis**: AI analyzes design requirements and existing style manifest
2. **Style Request Submission**: AI submits request via API endpoint with:
   - Proposed CSS properties
   - Semantic class name suggestion
   - Usage context and rationale
   - Design token compliance check
3. **Validation Pipeline**: 
   - Security sanitization (no external imports, scripts)
   - Stylelint compliance checking
   - Design system token validation
   - Accessibility contrast verification
4. **Human Review**: Design lead reviews and approves/rejects/modifies
5. **Compilation**: Approved styles compiled into versioned CSS library
6. **Block Association**: CSS library attached to specific blocks requiring styles

### 2.2 Style Request API Specification
```json
{
  "style_request": {
    "name": "hero-gradient-blue",
    "category": "utilities|components|layouts",
    "css_properties": {
      "background": "linear-gradient(135deg, var(--color-primary), var(--color-secondary))",
      "min-height": "60vh"
    },
    "design_tokens_used": ["--color-primary", "--color-secondary"],
    "usage_context": "Hero blocks requiring branded gradient background",
    "accessibility_notes": "Maintains 4.5:1 contrast ratio with white text"
  }
}
```

## 3. Security and Governance Framework

### 3.1 CSS Security Measures
- **Content Security Policy**: Prevent inline styles except whitelisted attributes
- **Sanitization Rules**:
  - No `@import` statements
  - No external URL references (except approved CDNs)
  - No JavaScript expressions or `url()` with scripts
  - No CSS custom properties that could override critical tokens
- **File Size Limits**: Maximum 50KB per style request
- **Rate Limiting**: Maximum 10 style requests per session

### 3.2 Approval Workflow States
1. **Draft**: AI-generated, awaiting security validation
2. **Validated**: Passed security checks, awaiting design review  
3. **Approved**: Design lead approved, ready for compilation
4. **Published**: Compiled into CSS library, available for use
5. **Deprecated**: Marked for removal, blocks must migrate to alternatives

### 3.3 Rollback and Version Management
- **Git Integration**: All style changes tracked in version control
- **Atomic Rollback**: Ability to revert entire style library versions
- **Block Dependency Mapping**: Track which blocks use which styles
- **Migration Assistance**: Automated suggestions for style updates

## 4. Design System Integration

### 4.1 Theme Manifest Structure
Maintain a machine-readable design system manifest:
```json
{
  "design_tokens": {
    "colors": {
      "--color-primary": "#2563eb",
      "--color-secondary": "#7c3aed"
    },
    "typography": {
      "--font-family-heading": "Inter, sans-serif",
      "--font-size-base": "1rem"
    },
    "spacing": {
      "--spacing-xs": "0.25rem",
      "--spacing-sm": "0.5rem"
    }
  },
  "utility_classes": [
    "text-primary", "bg-gradient", "container-fluid"
  ],
  "component_patterns": {
    "hero": {
      "required_classes": ["hero-container"],
      "optional_modifiers": ["hero--dark", "hero--centered"]
    }
  }
}
```

### 4.2 AI Style Guidelines
- **Prefer Existing Tokens**: AI should use existing design tokens before requesting new ones
- **Semantic Naming**: Class names must be semantic, not presentational (`hero-primary` not `blue-background`)
- **BEM Methodology**: Follow Block-Element-Modifier naming convention
- **Mobile-First**: All responsive styles should follow mobile-first approach
- **Performance Budget**: Consider CSS bundle size impact

## 5. Performance Considerations

### 5.1 CSS Loading Strategy
- **Lazy Loading**: Load AI-generated styles only when blocks are present
- **Critical CSS**: Include essential AI utilities in critical CSS path
- **Compression**: Gzip/Brotli compression for AI style libraries
- **Caching**: Aggressive caching with version-based cache busting

### 5.2 Bundle Management
- **Modular Compilation**: Separate libraries for different style categories
- **Tree Shaking**: Remove unused styles during compilation
- **Size Monitoring**: Alert when AI styles exceed performance budget
- **Optimization**: Automatic CSS minification and optimization

## 6. Implementation Recommendations

### 6.1 Phase 1: Foundation (Immediate)
- [ ] Create AI style request API endpoints
- [ ] Implement security validation pipeline
- [ ] Set up SCSS compilation system
- [ ] Create design token manifest
- [ ] Establish approval workflow

### 6.2 Phase 2: Advanced Features (6-12 months)
- [ ] Automated style optimization suggestions
- [ ] Visual regression testing for style changes
- [ ] AI-powered design token recommendations
- [ ] Cross-browser compatibility validation
- [ ] Advanced caching strategies

### 6.3 Phase 3: AI Enhancement (Future)
- [ ] Style conflict detection and resolution
- [ ] Automated accessibility compliance checking
- [ ] Machine learning-powered style optimization
- [ ] Predictive caching based on usage patterns

## 7. Monitoring and Maintenance

### 7.1 Style Governance Metrics
- Style request approval rate
- Average time from request to approval
- CSS bundle size growth over time
- Block dependency complexity
- Performance impact measurements

### 7.2 Cleanup and Maintenance
- **Regular Audits**: Monthly review of unused styles
- **Deprecation Process**: 30-day notice before style removal
- **Migration Tools**: Automated block style updates
- **Performance Reviews**: Quarterly CSS performance analysis

## 8. Risk Mitigation

### 8.1 Security Risks
- **Malicious CSS**: Prevented through sanitization and approval workflow
- **XSS Vectors**: Blocked by CSP and input validation
- **Resource Exhaustion**: Mitigated by file size and rate limits

### 8.2 Operational Risks  
- **Style Conflicts**: Minimized through namespacing and BEM methodology
- **Performance Degradation**: Monitored through automated bundle analysis
- **Approval Bottlenecks**: Addressed with clear SLA and escalation procedures

### 8.3 Business Continuity
- **Fallback Styles**: Graceful degradation when AI styles fail to load
- **Emergency Rollback**: Quick rollback process for problematic deployments
- **Backup Systems**: Regular backups of style libraries and manifests

## 9. Frequently Asked Questions

**Q: Can AI directly save CSS files to the sites directory?**
A: No. This would create security vulnerabilities and bypass governance controls. All styles must go through the controlled API and approval process.

**Q: How do we handle urgent style fixes?**
A: Emergency approval process allows senior developers to fast-track critical style changes with post-approval review.

**Q: What happens if the AI generates conflicting styles?**
A: The validation pipeline detects conflicts and either auto-resolves or flags for human review before compilation.

**Q: How do we prevent CSS bloat from AI-generated styles?**
A: Regular audits, automated cleanup of unused styles, and performance budgets prevent excessive growth.

**Q: Can AI modify existing theme styles?**
A: No. AI can only create new scoped styles. Modifications to base theme styles require human developer intervention.

## 10. Conclusion

This specification provides a secure, scalable approach to stylesheet management that balances AI automation with human oversight. The controlled style library approach ensures security while maintaining design system consistency and performance standards.

The key principles are:
- **Security First**: No direct file system access, comprehensive validation
- **Human Oversight**: Required approval for all style additions
- **Performance Aware**: Lazy loading and bundle optimization
- **Design System Aligned**: Consistent with existing tokens and patterns
- **Auditable**: Full tracking and rollback capabilities

Implementation should begin with Phase 1 foundations, establishing the security and governance framework before enabling AI style generation capabilities.